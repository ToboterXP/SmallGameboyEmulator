/*
 * icb00_cbff.cpp
 *
 *  Created on: 16.10.2019
 *      Author: Tobias
 */

#include "icb00_cbff.h"

namespace proc {


uint8_t setBit(uint8_t val,uint8_t bit) {
	return val | (1<<bit);
}

uint8_t resetBit(uint8_t val,uint8_t bit) {
	return val & (~(1<<bit));
}

bool getBit(uint8_t val,uint8_t bit) {
	return (val>>bit)&1;
}

int executeCB(uint8_t opcode, Processor * proc) {
	uint8_t source = 0;
	switch(opcode%8) {
	case 0:
		source = proc->b;
		break;
	case 1:
		source = proc->c;
		break;
	case 2:
		source = proc->d;
		break;
	case 3:
		source = proc->e;
		break;
	case 4:
		source = proc->h;
		break;
	case 5:
		source = proc->l;
		break;
	case 6:
		source = proc->memory->readMemory(proc->getHL());
		break;
	case 7:
		source = proc->a;
		break;
	}

	uint8_t result = 0;

	if (opcode>=0xc0) { //set *,b
		result = setBit(source,(opcode-0xc0)/8);
	} else if (opcode >= 0x80) { //res *,b
		result = resetBit(source,(opcode-0x80)/8);
	} else if (opcode >=0x40) { //bit *,b
		proc->setFlag(ZERO_FLAG,getBit(source,(opcode-0x40)/8));
		return opcode%8==6 ? 4 :2;
	}

	switch (opcode%8) {
	case 0:
		proc->b = result;
		break;
	case 1:
		proc->c = result;
		break;
	case 2:
		proc->d = result;
		break;
	case 3:
		proc->e = result;
		break;
	case 4:
		proc->h = result;
		break;
	case 5:
		proc->l = result;
		break;
	case 6:
		proc->memory->writeMemory(proc->getHL(),result);
		break;
	case 7:
		proc->a = result;
		break;
	}
	return opcode%8==6 ? 4 :2;
}

}

